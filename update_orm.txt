# DANH SÁCH FILE CẦN SỬA ĐỔI ĐỂ CHUYỂN SANG ORM REPOSITORY

## 1. File Repository Interface & Implementation
---- start file internal/repository/interface.go----
package repository

import (
	"context"
	"time"

	"remiaq/internal/models"
)

// ReminderRepository defines operations for reminder data access
type ReminderRepository interface {
	// CRUD operations
	Create(ctx context.Context, reminder *models.Reminder) error
	GetByID(ctx context.Context, id string) (*models.Reminder, error)
	Update(ctx context.Context, reminder *models.Reminder) error
	Delete(ctx context.Context, id string) error

	// Query operations
	GetDueReminders(ctx context.Context, beforeTime time.Time) ([]*models.Reminder, error)
	GetByUserID(ctx context.Context, userID string) ([]*models.Reminder, error)

	// Specific updates
	UpdateNextTrigger(ctx context.Context, id string, nextTrigger time.Time) error
	UpdateStatus(ctx context.Context, id string, status string) error
	IncrementRetryCount(ctx context.Context, id string) error
	UpdateSnooze(ctx context.Context, id string, snoozeUntil string) error
	MarkCompleted(ctx context.Context, id string, completedAt string) error
	UpdateLastSent(ctx context.Context, id string, lastSentAt string) error
}
-----end file internal/repository/interface.go-----

---- start file internal/repository/pocketbase/reminder_orm_repo.go----
package pocketbase

import (
	"context"
	"encoding/json"
	"fmt"
	"time"

	"remiaq/internal/models"
	"remiaq/internal/repository"

	"github.com/pocketbase/pocketbase"
	"github.com/pocketbase/pocketbase/core"
)

// ReminderORMRepo implements ReminderRepository using PocketBase ORM
type ReminderORMRepo struct {
	app *pocketbase.PocketBase
}

var _ repository.ReminderRepository = (*ReminderORMRepo)(nil)

func NewReminderORMRepo(app *pocketbase.PocketBase) repository.ReminderRepository {
	return &ReminderORMRepo{app: app}
}

// ... implementation methods using app.DB().NewQuery(), Bind(), One(), All(), Execute()
-----end file internal/repository/pocketbase/reminder_orm_repo.go-----

## 2. File Repository SQL hiện tại (có thể giữ làm backup)
---- start file internal/repository/pocketbase/reminder_repo.go----
package pocketbase

import (
	"context"
	"encoding/json"
	"fmt"
	"time"

	"remiaq/internal/db"
	"remiaq/internal/models"
	"remiaq/internal/repository"

	"github.com/pocketbase/dbx"
	"github.com/pocketbase/pocketbase"
	"github.com/pocketbase/pocketbase/core"
)

// ReminderRepo implements ReminderRepository using SQL queries
type ReminderRepo struct {
	helper db.DBHelperInterface
}

var _ repository.ReminderRepository = (*ReminderRepo)(nil)

func NewReminderRepo(app *pocketbase.PocketBase) repository.ReminderRepository {
	return &ReminderRepo{helper: db.NewDBHelper(app)}
}

// ... implementation methods using db helper functions
-----end file internal/repository/pocketbase/reminder_repo.go-----

## 3. File Services sử dụng Repository
---- start file internal/services/reminder_service.go----
package services

import (
	"context"
	"errors"
	"fmt"
	"time"

	"remiaq/internal/models"
	"remiaq/internal/repository"
)

// ReminderService handles reminder business logic
type ReminderService struct {
	reminderRepo    repository.ReminderRepository
	userRepo        repository.UserRepository
	fcmService      FCMServiceInterface
	schedCalculator *ScheduleCalculator
}

func NewReminderService(
	reminderRepo repository.ReminderRepository,
	userRepo repository.UserRepository,
	fcmService FCMServiceInterface,
	schedCalculator *ScheduleCalculator,
) *ReminderService {
	return &ReminderService{
		reminderRepo:    reminderRepo,
		userRepo:        userRepo,
		fcmService:      fcmService,
		schedCalculator: schedCalculator,
	}
}
-----end file internal/services/reminder_service.go-----

## 4. File Main Application
---- start file cmd/server/main.go----
package main

import (
	"log"
	"os"
	"os/signal"
	"syscall"

	"remiaq/internal/handlers"
	"remiaq/internal/repository"
	pbRepo "remiaq/internal/repository/pocketbase"
	"remiaq/internal/services"
	"remiaq/internal/worker"

	"github.com/pocketbase/pocketbase"
)

func main() {
	app := pocketbase.New()

	// Initialize repositories
	reminderRepo := pbRepo.NewReminderRepo(app) // Cần đổi thành NewReminderORMRepo
	userRepo := pbRepo.NewUserRepo(app)
	systemStatusRepo := pbRepo.NewSystemStatusRepo(app)
	queryRepo := pbRepo.NewQueryRepo(app)

	// Initialize services
	fcmService := services.NewFCMService()
	schedCalculator := services.NewScheduleCalculator()
	reminderService := services.NewReminderService(
		reminderRepo,
		userRepo,
		fcmService,
		schedCalculator,
	)

	// ... rest of the code
}
-----end file cmd/server/main.go-----

## 5. File Worker sử dụng Service
---- start file internal/worker/worker.go----
package worker

import (
	"context"
	"fmt"
	"log"
	"time"

	"remiaq/internal/repository"
	"remiaq/internal/services"
)

type Worker struct {
	reminderService *services.ReminderService
	systemStatusRepo repository.SystemStatusRepository
	interval         time.Duration
}

func NewWorker(
	reminderService *services.ReminderService,
	systemStatusRepo repository.SystemStatusRepository,
	interval time.Duration,
) *Worker {
	return &Worker{
		reminderService: reminderService,
		systemStatusRepo: systemStatusRepo,
		interval:         interval,
	}
}
-----end file internal/worker/worker.go-----

## 6. Các Repository khác cần cập nhật tương tự
---- start file internal/repository/pocketbase/user_repo.go----
package pocketbase

import (
	"context"
	"time"

	"remiaq/internal/db"
	"remiaq/internal/models"
	"remiaq/internal/repository"

	"github.com/pocketbase/dbx"
	"github.com/pocketbase/pocketbase"
)

// UserRepo implements UserRepository
type UserRepo struct {
	helper db.DBHelperInterface
}

var _ repository.UserRepository = (*UserRepo)(nil)

func NewUserRepo(app *pocketbase.PocketBase) repository.UserRepository {
	return &UserRepo{helper: db.NewDBHelper(app)}
}
-----end file internal/repository/pocketbase/user_repo.go-----

---- start file internal/repository/pocketbase/system_status_repo.go----
package pocketbase

import (
	"context"
	"time"

	"remiaq/internal/db"
	"remiaq/internal/models"
	"remiaq/internal/repository"

	"github.com/pocketbase/dbx"
	"github.com/pocketbase/pocketbase"
)

// SystemStatusRepo implements SystemStatusRepository
type SystemStatusRepo struct {
	helper db.DBHelperInterface
}

var _ repository.SystemStatusRepository = (*SystemStatusRepo)(nil)

func NewSystemStatusRepo(app *pocketbase.PocketBase) repository.SystemStatusRepository {
	return &SystemStatusRepo{helper: db.NewDBHelper(app)}
}
-----end file internal/repository/pocketbase/system_status_repo.go-----



## Thông tin về Models & Collections
### 1. Collection Names trong PocketBase:
- reminders - Collection cho nhắc nhở
- users - Collection cho người dùng
- system_status - Collection cho trạng thái hệ thống
### 2. Struct Models:
a. Models.Reminder:

type Reminder struct {
    ID                string             `json:"id" db:"id"`
    UserID            string             `json:"user_id" db:"user_id"`
    Title             string             `json:"title" db:"title"`
    Description       string             `json:"description" db:"description"`
    Type              string             `json:"type" db:"type"`                   // one_time, recurring
    CalendarType      string             `json:"calendar_type" db:"calendar_type"` // solar, lunar
    NextTriggerAt     string             `json:"next_trigger_at" db:"next_trigger_at"`
    TriggerTimeOfDay  string             `json:"trigger_time_of_day" db:"trigger_time_of_day"` // HH:MM format
    RecurrencePattern *RecurrencePattern `json:"recurrence_pattern" db:"recurrence_pattern"`   // JSON field
    RepeatStrategy    string             `json:"repeat_strategy" db:"repeat_strategy"`         // none, retry_until_complete
    RetryIntervalSec  int                `json:"retry_interval_sec" db:"retry_interval_sec"`
    MaxRetries        int                `json:"max_retries" db:"max_retries"`
    RetryCount        int                `json:"retry_count" db:"retry_count"`
    Status            string             `json:"status" db:"status"` // active, completed, paused
    SnoozeUntil       string             `json:"snooze_until" db:"snooze_until"`
    LastCompletedAt   string             `json:"last_completed_at" db:"last_completed_at"`
    LastSentAt        string             `json:"last_sent_at" db:"last_sent_at"`
    Created           time.Time          `json:"created" db:"created"`
    Updated           time.Time          `json:"updated" db:"updated"`
}


type User struct {
    ID          string    `json:"id" db:"id"`
    Email       string    `json:"email" db:"email"`
    FCMToken    string    `json:"fcm_token" db:"fcm_token"`
    IsFCMActive bool      `json:"is_fcm_active" db:"is_fcm_active"`
    Created     time.Time `json:"created" db:"created"`
    Updated     time.Time `json:"updated" db:"updated"`
}

### 3. Relationships:
- Reminder → User : Mỗi reminder có UserID để liên kết với user
- Không có foreign key constraints trong PocketBase, chỉ là logical relationships
### 4. DB Helper hiện tại:
File `db_utils.go` có các hàm chính:
type DBHelperInterface interface {
    GetOneRow(query string, params dbx.Params) (dbx.NullStringMap, error)
    GetAllRows(query string, params dbx.Params) ([]dbx.NullStringMap, error)
    Exec(query string, params dbx.Params) error
    Count(query string, params dbx.Params) (int, error)
    Exists(query string, params dbx.Params) (bool, error)
    App() *pocketbase.PocketBase
}

Generic functions:

- GetOne[T]() - Lấy 1 record
- GetAll[T]() - Lấy nhiều records
- GetOneWithConfig[T]() - Lấy 1 record với config mapping
- GetAllWithConfig[T]() - Lấy nhiều records với config mapping
### 5. ORM Helper mới:
File `orm_helper.go` đã có sẵn interface cho ORM:

type ORMDBHelperInterface interface {
    FindCollectionByNameOrId(nameOrId string) (*core.Collection, error)
    Save(record *core.Record) error
}
